import os
import time
import hmac
import hashlib
import base64
import requests
import json
import pandas as pd
import numpy as np
from flask import Flask, jsonify, request
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
import threading

app = Flask(__name__)

# FUTURES TRADING CONFIGURATION
class Config:
    def __init__(self):
        self.api_key = os.environ.get('COINCATCH_API_KEY', '')
        self.api_secret = os.environ.get('COINCATCH_API_SECRET', '') 
        self.passphrase = os.environ.get('COINCATCH_PASSPHRASE', '')
        self.base_url = "https://api.coincatch.com"
        self.is_configured = bool(self.api_key and self.api_secret and self.passphrase)
        
        self.timezone = ZoneInfo('America/New_York')
        
        # üöÄ FUTURES SETTINGS üöÄ
        self.leverage_multiplier = 5  # Your simple multiplier: 1-20x
        self.base_position_size = 0.1  # Base position size in SOL
        self.check_interval = 300  # 5 minutes
        
        # Aggressive Indicators
        self.rsi_period = 7
        self.macd_fast = 6
        self.macd_slow = 13  
        self.macd_signal = 5
        
        # Risk Management
        self.max_daily_loss = 0.10  # 10% daily loss limit
        self.stop_loss_pct = 0.05   # 5% stop loss
        self.take_profit_pct = 0.10 # 10% take profit
        
        # Trading parameters
        self.symbol = "SOLUSDT_UMCBL"  # Futures symbol
        self.margin_mode = "crossed"   # or "isolated"
        self.position_side = "LONG"    # or "SHORT" - auto-decided

config = Config()

def get_ny_time():
    return datetime.now(config.timezone)

class TradingState:
    def __init__(self):
        self.is_running = False
        self.current_position = None  # 'long', 'short', or None
        self.position_size = 0.0
        self.entry_price = 0.0
        self.unrealized_pnl = 0.0
        self.realized_pnl = 0.0
        self.last_trade_time = None
        self.last_signals = {}
        self.trade_history = []
        
        # Performance tracking
        self.daily_starting_balance = 0.0
        self.daily_start_time = get_ny_time()
        self.total_trades = 0
        self.winning_trades = 0
        
trading_state = TradingState()

def make_api_request(method, endpoint, data=None):
    """Make authenticated API request for futures"""
    if not config.is_configured:
        return {'error': 'API credentials not configured'}
    
    try:
        timestamp = str(int(time.time() * 1000))
        body_string = json.dumps(data) if data else ''
        message = f"{timestamp}{method.upper()}{endpoint}{body_string}"
        
        signature = base64.b64encode(
            hmac.new(
                config.api_secret.encode('utf-8'),
                message.encode('utf-8'),
                hashlib.sha256
            ).digest()
        ).decode()

        headers = {
            'ACCESS-KEY': config.api_key,
            'ACCESS-SIGN': signature,
            'ACCESS-TIMESTAMP': timestamp,
            'ACCESS-PASSPHRASE': config.passphrase,
            'Content-Type': 'application/json'
        }

        url = config.base_url + endpoint
        timeout = 5
        
        if method.upper() == 'GET':
            response = requests.get(url, headers=headers, timeout=timeout)
        else:
            response = requests.post(url, headers=headers, json=data, timeout=timeout)
        
        if response.headers.get('content-type', '').startswith('application/json'):
            response_data = response.json()
        else:
            return {'error': f'HTTP {response.status_code}', 'message': 'Server returned non-JSON response'}
        
        if response.status_code == 200:
            return response_data
        else:
            return {'error': f'HTTP {response.status_code}', 'message': response_data.get('msg', str(response_data))}
            
    except Exception as e:
        return {'error': f'Request failed: {str(e)}'}

def get_current_price():
    """Get current SOL price from futures market"""
    try:
        result = make_api_request('GET', f'/api/mix/v1/market/ticker?symbol={config.symbol}')
        
        if 'error' in result:
            print(f"Failed to get price: {result.get('message')}")
            return None
        
        if 'data' in result:
            data = result['data']
            if isinstance(data, dict):
                return float(data.get('lastPr', data.get('last', 0)))
            elif isinstance(data, list) and len(data) > 0:
                return float(data[0].get('lastPr', data[0].get('last', 0)))
        
        return None
    except Exception as e:
        print(f"Error getting price: {e}")
        return None

def get_klines(interval='5m', limit=50):
    """Fetch candlestick data for futures"""
    try:
        interval_map = {'1m': '60', '5m': '300', '15m': '900', '30m': '1800', '1H': '3600', '4H': '14400', '1D': '86400'}
        granularity = interval_map.get(interval, '300')
        
        endpoint = f'/api/mix/v1/market/candles?symbol={config.symbol}&granularity={granularity}&limit={limit}'
        result = make_api_request('GET', endpoint)
        
        if 'error' in result:
            return None
            
        if 'data' in result:
            data = result['data']
            df = pd.DataFrame(data)
            if df.empty:
                return None
                
            if len(df.columns) >= 6:
                df.columns = ['timestamp', 'open', 'high', 'low', 'close', 'volume'] + list(df.columns[6:])
                
            for col in ['open', 'high', 'low', 'close', 'volume']:
                df[col] = pd.to_numeric(df[col], errors='coerce')
            
            return df
        return None
    except Exception as e:
        print(f"Error fetching klines: {e}")
        return None

def calculate_rsi(df, period=14):
    """Calculate RSI"""
    try:
        delta = df['close'].diff()
        gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
        rs = gain / loss
        rsi = 100 - (100 / (1 + rs))
        return rsi.iloc[-1] if not pd.isna(rsi.iloc[-1]) else 50
    except:
        return 50

def calculate_macd(df, fast=12, slow=26, signal=9):
    """Calculate MACD"""
    try:
        close = df['close']
        ema_fast = close.ewm(span=fast, adjust=False).mean()
        ema_slow = close.ewm(span=slow, adjust=False).mean()
        macd_line = ema_fast - ema_slow
        signal_line = macd_line.ewm(span=signal, adjust=False).mean()
        histogram = macd_line - signal_line
        
        current_macd = macd_line.iloc[-1]
        current_signal = signal_line.iloc[-1]
        
        if current_macd > current_signal:
            return 1  # Bullish
        else:
            return -1  # Bearish
    except:
        return 0

def calculate_trend_strength(df):
    """Calculate trend strength"""
    try:
        # Multiple timeframe analysis
        price_change_5 = (df['close'].iloc[-1] - df['close'].iloc[-5]) / df['close'].iloc[-5]
        price_change_10 = (df['close'].iloc[-1] - df['close'].iloc[-10]) / df['close'].iloc[-10]
        
        # Combined strength
        strength = (abs(price_change_5) + abs(price_change_10)) / 2
        direction = 1 if price_change_5 > 0 else -1
        
        return strength * direction
    except:
        return 0

def get_trading_signals():
    """Generate trading signals for futures"""
    try:
        df = get_klines(interval='5m', limit=50)
        current_price = get_current_price()
        
        if df is None or current_price is None:
            return None
        
        # Calculate indicators
        rsi = calculate_rsi(df, config.rsi_period)
        macd_signal = calculate_macd(df, config.macd_fast, config.macd_slow, config.macd_signal)
        trend_strength = calculate_trend_strength(df)
        
        signals = {
            'rsi': rsi,
            'macd': macd_signal,
            'trend_strength': abs(trend_strength),
            'trend_direction': 1 if trend_strength > 0 else -1,
            'price': current_price,
            'timestamp': get_ny_time().isoformat()
        }
        
        # Decision logic
        bullish_score = 0
        bearish_score = 0
        
        # Bullish conditions
        if macd_signal == 1:
            bullish_score += 2
        if rsi < 70:
            bullish_score += 1
        if trend_strength > 0 and abs(trend_strength) > 0.3:
            bullish_score += 2
            
        # Bearish conditions
        if macd_signal == -1:
            bearish_score += 2
        if rsi > 30:
            bearish_score += 1
        if trend_strength < 0 and abs(trend_strength) > 0.3:
            bearish_score += 2
        
        # Make decision
        if bullish_score >= 3 and bearish_score < 3:
            signals['action'] = 'LONG'
            signals['confidence'] = min(1.0, bullish_score / 5.0)
        elif bearish_score >= 3 and bullish_score < 3:
            signals['action'] = 'SHORT' 
            signals['confidence'] = min(1.0, bearish_score / 5.0)
        else:
            signals['action'] = 'HOLD'
            signals['confidence'] = 0.5
            
        return signals
        
    except Exception as e:
        print(f"Error getting signals: {e}")
        return None

def set_leverage():
    """Set leverage for the futures position"""
    try:
        leverage_data = {
            "symbol": config.symbol,
            "marginMode": config.margin_mode,
            "leverage": str(config.leverage_multiplier)
        }
        result = make_api_request('POST', '/api/mix/v1/account/setLeverage', leverage_data)
        return 'error' not in result
    except Exception as e:
        print(f"Error setting leverage: {e}")
        return False

def get_account_balance():
    """Get futures account balance"""
    try:
        result = make_api_request('GET', '/api/mix/v1/account/accounts')
        if 'error' not in result and 'data' in result:
            # Assuming USDT-M futures, look for USDT balance
            for account in result['data']:
                if account.get('marginCoin') == 'USDT':
                    return float(account.get('available', 0))
        return 0.0
    except Exception as e:
        print(f"Error getting balance: {e}")
        return 0.0

def open_long_position(quantity):
    """Open a long futures position"""
    try:
        order_data = {
            "symbol": config.symbol,
            "marginCoin": "USDT",
            "side": "open_long",
            "orderType": "market",
            "size": str(quantity),
            "timInForce": "normal"
        }
        result = make_api_request('POST', '/api/mix/v1/order/placeOrder', order_data)
        return 'error' not in result
    except Exception as e:
        print(f"Error opening long: {e}")
        return False

def open_short_position(quantity):
    """Open a short futures position"""
    try:
        order_data = {
            "symbol": config.symbol,
            "marginCoin": "USDT",
            "side": "open_short", 
            "orderType": "market",
            "size": str(quantity),
            "timInForce": "normal"
        }
        result = make_api_request('POST', '/api/mix/v1/order/placeOrder', order_data)
        return 'error' not in result
    except Exception as e:
        print(f"Error opening short: {e}")
        return False

def close_position():
    """Close current futures position"""
    try:
        if trading_state.current_position == 'long':
            side = "close_long"
        elif trading_state.current_position == 'short':
            side = "close_short"
        else:
            return True
            
        order_data = {
            "symbol": config.symbol,
            "marginCoin": "USDT",
            "side": side,
            "orderType": "market",
            "size": str(trading_state.position_size),
            "timInForce": "normal"
        }
        result = make_api_request('POST', '/api/mix/v1/order/placeOrder', order_data)
        
        if 'error' not in result:
            # Calculate P&L
            current_price = get_current_price()
            if current_price and trading_state.entry_price:
                if trading_state.current_position == 'long':
                    pnl = (current_price - trading_state.entry_price) * trading_state.position_size
                else:
                    pnl = (trading_state.entry_price - current_price) * trading_state.position_size
                
                trading_state.realized_pnl += pnl
                if pnl > 0:
                    trading_state.winning_trades += 1
                    
            trading_state.current_position = None
            trading_state.position_size = 0.0
            trading_state.entry_price = 0.0
            return True
        return False
    except Exception as e:
        print(f"Error closing position: {e}")
        return False

def check_position_health():
    """Check if current position needs to be closed due to stop loss/take profit"""
    if not trading_state.current_position or trading_state.entry_price == 0:
        return True
        
    current_price = get_current_price()
    if not current_price:
        return True
        
    # Calculate P&L percentage
    if trading_state.current_position == 'long':
        pnl_pct = (current_price - trading_state.entry_price) / trading_state.entry_price
    else:
        pnl_pct = (trading_state.entry_price - current_price) / trading_state.entry_price
        
    trading_state.unrealized_pnl = pnl_pct
    
    # Check stop loss and take profit
    if pnl_pct <= -config.stop_loss_pct:
        print(f"üö® STOP LOSS HIT: {pnl_pct:.2%}")
        return close_position()
    elif pnl_pct >= config.take_profit_pct:
        print(f"üéØ TAKE PROFIT HIT: {pnl_pct:.2%}")
        return close_position()
        
    return True

def check_risk_limits():
    """Check daily loss limits"""
    try:
        current_balance = get_account_balance()
        if trading_state.daily_starting_balance > 0:
            daily_pnl_pct = (current_balance - trading_state.daily_starting_balance) / trading_state.daily_starting_balance
            if daily_pnl_pct <= -config.max_daily_loss:
                print(f"üö® DAILY LOSS LIMIT REACHED: {daily_pnl_pct:.1%}")
                return False
        
        # Reset daily tracking if new day
        current_time = get_ny_time()
        if current_time.date() != trading_state.daily_start_time.date():
            trading_state.daily_starting_balance = current_balance
            trading_state.daily_start_time = current_time
            
        return True
    except:
        return True

def futures_trading_loop():
    """üöÄ MAIN FUTURES TRADING LOOP üöÄ"""
    print("\n" + "="*70)
    print("üöÄ FUTURES TRADING BOT ACTIVATED üöÄ")
    print(f"Leverage: {config.leverage_multiplier}x")
    print(f"Symbol: {config.symbol}")
    print("STRATEGY: Auto Long/Short with Trend Following")
    print("="*70)
    
    # Set initial leverage
    if not set_leverage():
        print("‚ùå Failed to set leverage")
        trading_state.is_running = False
        return
        
    trading_state.daily_starting_balance = get_account_balance()
    
    while trading_state.is_running:
        try:
            if not trading_state.is_running:
                break
                
            # Check risk limits
            if not check_risk_limits():
                print("üõë Risk limits exceeded - stopping bot")
                trading_state.is_running = False
                break
                
            # Check current position health
            if not check_position_health():
                print("‚ùå Position health check failed")
                continue
                
            # Get trading signals
            signals = get_trading_signals()
            if signals is None:
                time.sleep(config.check_interval)
                continue
                
            trading_state.last_signals = signals
            current_balance = get_account_balance()
            
            print(f"\n‚è∞ {signals['timestamp'][11:19]} | Price: ${signals['price']:.2f}")
            print(f"üìä RSI: {signals['rsi']:.1f} | MACD: {signals['macd']} | Trend: {signals['trend_strength']:.2f}")
            print(f"üí∞ Balance: ${current_balance:.2f} | Position: {trading_state.current_position or 'NONE'}")
            print(f"üéØ Signal: {signals['action']} | Confidence: {signals['confidence']:.1%}")
            
            # Calculate position size based on leverage and confidence
            effective_size = config.base_position_size * config.leverage_multiplier * signals['confidence']
            
            # Execute trading logic
            if signals['action'] == 'LONG' and trading_state.current_position != 'long':
                # Close any existing position first
                if trading_state.current_position:
                    close_position()
                    time.sleep(1)
                    
                print(f"üöÄ OPENING LONG: {effective_size:.3f} SOL with {config.leverage_multiplier}x leverage")
                if open_long_position(effective_size):
                    trading_state.current_position = 'long'
                    trading_state.position_size = effective_size
                    trading_state.entry_price = signals['price']
                    trading_state.last_trade_time = get_ny_time()
                    trading_state.total_trades += 1
                    
                    trading_state.trade_history.append({
                        'time': get_ny_time().isoformat(),
                        'action': 'LONG',
                        'size': effective_size,
                        'leverage': config.leverage_multiplier,
                        'entry_price': signals['price'],
                        'confidence': signals['confidence']
                    })
                    
            elif signals['action'] == 'SHORT' and trading_state.current_position != 'short':
                # Close any existing position first
                if trading_state.current_position:
                    close_position()
                    time.sleep(1)
                    
                print(f"üìâ OPENING SHORT: {effective_size:.3f} SOL with {config.leverage_multiplier}x leverage")
                if open_short_position(effective_size):
                    trading_state.current_position = 'short'
                    trading_state.position_size = effective_size
                    trading_state.entry_price = signals['price']
                    trading_state.last_trade_time = get_ny_time()
                    trading_state.total_trades += 1
                    
                    trading_state.trade_history.append({
                        'time': get_ny_time().isoformat(),
                        'action': 'SHORT', 
                        'size': effective_size,
                        'leverage': config.leverage_multiplier,
                        'entry_price': signals['price'],
                        'confidence': signals['confidence']
                    })
                    
            elif signals['action'] == 'HOLD' and trading_state.current_position:
                print("‚è∏Ô∏è  Holding position - monitoring...")
                
            time.sleep(config.check_interval)
            
        except Exception as e:
            print(f"Error in trading loop: {e}")
            time.sleep(config.check_interval)
    
    # Close any open position when stopping
    if trading_state.current_position:
        close_position()
        
    print("\nüõë FUTURES BOT STOPPED")

# ========== FLASK ROUTES ==========

@app.route('/')
def index():
    # Return the HTML directly instead of using templates
    return """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Futures Trading Bot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid #667eea;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            color: #666;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .warning-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            border: 2px solid #fff;
        }
        
        .warning-banner h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border: 2px solid #a29bfe;
        }
        
        .card.futures {
            border: 2px solid #667eea;
            background: linear-gradient(135deg, #fff, #d6bcfa);
        }
        
        .card h2 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 2px solid #a3bffa;
            padding-bottom: 10px;
        }
        
        .card.futures h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .status-item.futures {
            border-left: 4px solid #5a67d8;
            background: linear-gradient(135deg, #f8f9fa, #d6bcfa);
        }
        
        .status-item label {
            display: block;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .status-item .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
        }
        
        .status-running { color: #00b894 !important; }
        .status-stopped { color: #ff7675 !important; }
        .status-long { color: #00b894 !important; }
        .status-short { color: #ff7675 !important; }
        
        .signal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .signal-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #ddd;
        }
        
        .signal-item.long {
            background: linear-gradient(135deg, #00b894, #55efc4);
            border-color: #00b894;
            color: white;
        }
        
        .signal-item.short {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            border-color: #ff7675;
            color: white;
        }
        
        .signal-item.hold {
            background: linear-gradient(135deg, #fdcb6e, #ffeaa7);
            border-color: #fdcb6e;
            color: #2d3436;
        }
        
        .signal-label {
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .signal-value {
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .performance-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #ddd;
        }
        
        .performance-item.leverage {
            background: linear-gradient(135deg, #d6bcfa, #a3bffa);
            border-color: #667eea;
        }
        
        .performance-item .label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .performance-item .value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .positive { color: #00b894; }
        .negative { color: #ff7675; }
        .extreme-positive { color: #00cec9; font-weight: 900; }
        .extreme-negative { color: #d63031; font-weight: 900; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3436;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group.emergency-group {
            margin-top: 15px;
            justify-content: center;
        }
        
        button {
            flex: 1;
            padding: 18px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .start-button {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4);
        }
        
        .start-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.6);
        }
        
        .stop-button {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
        }
        
        .stop-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 118, 117, 0.6);
        }
        
        .emergency-button {
            background: linear-gradient(135deg, #e17055, #ff7675);
            color: white;
            box-shadow: 0 5px 15px rgba(225, 112, 85, 0.4);
            flex: 0 0 auto;
            width: 100%;
            max-width: 400px;
        }
        
        .emergency-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(225, 112, 85, 0.6);
        }
        
        .close-button {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: white;
        }
        
        .update-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .leverage-meter {
            background: linear-gradient(90deg, #00b894, #fdcb6e, #ff7675);
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
            position: relative;
        }
        
        .leverage-marker {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 20px;
            background: #2d3436;
            transform: translateX(-50%);
        }
        
        .trade-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .trade-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .trade-item.long {
            border-left: 4px solid #00b894;
            background: linear-gradient(135deg, #f8f9fa, #55efc4);
        }
        
        .trade-item.short {
            border-left: 4px solid #ff7675;
            background: linear-gradient(135deg, #f8f9fa, #fd79a8);
        }
        
        .trade-item .trade-time {
            color: #666;
            font-size: 0.9em;
        }
        
        .trade-item .trade-action {
            font-weight: bold;
            margin: 5px 0;
            font-size: 1.1em;
        }
        
        #result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .strategy-info {
            background: linear-gradient(135deg, #d6bcfa, #a3bffa);
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .strategy-info h4 {
            color: #5a67d8;
            margin-bottom: 10px;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .control-section {
            margin-bottom: 25px;
        }
        
        .control-section:last-child {
            margin-bottom: 0;
        }
        
        .section-title {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
            border-bottom: 2px solid #a3bffa;
            padding-bottom: 8px;
        }
        
        .pnl-display {
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .pnl-positive {
            background: linear-gradient(135deg, #00b894, #55efc4);
            color: white;
        }
        
        .pnl-negative {
            background: linear-gradient(135deg, #ff7675, #fd79a8);
            color: white;
        }
        
        .pnl-neutral {
            background: #f8f9fa;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ FUTURES TRADING BOT</h1>
            <p>Auto Long/Short with Leverage - Set & Forget</p>
        </div>
        
        <div class="warning-banner">
            <h3>‚ö†Ô∏è EXTREME LEVERAGE RISK WARNING ‚ö†Ô∏è</h3>
            <p>FUTURES TRADING WITH LEVERAGE CAN LEAD TO COMPLETE LOSS OF CAPITAL</p>
            <p>Only use risk capital you can afford to lose 100%!</p>
        </div>
        
        <div class="card futures">
            <h2>üéØ Strategy Overview</h2>
            <div class="strategy-info">
                <h4>ü§ñ AUTO LONG/SHORT FUTURES TRADING</h4>
                <p><strong>Method:</strong> Bot automatically decides Long or Short based on trend analysis</p>
                <p><strong>Your Role:</strong> Just set the leverage multiplier (1-20x)</p>
                <p><strong>Risk:</strong> EXTREME - Leverage amplifies both gains and losses</p>
            </div>
            
            <div class="status-grid">
                <div class="status-item futures">
                    <label>Bot Status:</label>
                    <div class="value" id="botStatus">STOPPED</div>
                </div>
                <div class="status-item futures">
                    <label>Current Position:</label>
                    <div class="value" id="position">NONE</div>
                </div>
                <div class="status-item futures">
                    <label>Leverage Multiplier:</label>
                    <div class="value" id="leverageDisplay">5x</div>
                </div>
                <div class="status-item futures">
                    <label>Check Frequency:</label>
                    <div class="value">5 MINUTES</div>
                </div>
            </div>
        </div>
        
        <div class="card futures">
            <h2>üìä Live Trading Data</h2>
            <div class="status-grid">
                <div class="status-item futures">
                    <label>SOL Price:</label>
                    <div class="value" id="solPrice">$--</div>
                </div>
                <div class="status-item futures">
                    <label>Account Balance:</label>
                    <div class="value" id="accountBalance">$--</div>
                </div>
                <div class="status-item futures">
                    <label>Position Size:</label>
                    <div class="value" id="positionSize">-- SOL</div>
                </div>
                <div class="status-item futures">
                    <label>Entry Price:</label>
                    <div class="value" id="entryPrice">$--</div>
                </div>
            </div>
            
            <div class="performance-grid">
                <div class="performance-item leverage">
                    <div class="label">Unrealized P&L</div>
                    <div class="value" id="unrealizedPnl">--%</div>
                </div>
                <div class="performance-item leverage">
                    <div class="label">Realized P&L</div>
                    <div class="value" id="realizedPnl">$--</div>
                </div>
                <div class="performance-item leverage">
                    <div class="label">Total Trades</div>
                    <div class="value" id="totalTrades">0</div>
                </div>
                <div class="performance-item leverage">
                    <div class="label">Win Rate</div>
                    <div class="value" id="winRate">--%</div>
                </div>
            </div>
            
            <div id="pnlDisplay" class="pnl-display pnl-neutral">
                Current P&L: $0.00 (0.00%)
            </div>
        </div>
        
        <div class="card futures">
            <h2>üìà Trading Signals</h2>
            <div class="signal-grid">
                <div class="signal-item" id="rsiSignal">
                    <div class="signal-label">RSI (7)</div>
                    <div class="signal-value">--</div>
                </div>
                <div class="signal-item" id="macdSignal">
                    <div class="signal-label">MACD Signal</div>
                    <div class="signal-value">--</div>
                </div>
                <div class="signal-item" id="trendSignal">
                    <div class="signal-label">Trend Power</div>
                    <div class="signal-value">--</div>
                </div>
                <div class="signal-item" id="confidenceSignal">
                    <div class="signal-label">Confidence</div>
                    <div class="signal-value">--%</div>
                </div>
                <div class="signal-item" id="actionSignal">
                    <div class="signal-label">TRADE SIGNAL</div>
                    <div class="signal-value">HOLD</div>
                </div>
                <div class="signal-item" id="leverageSignal">
                    <div class="signal-label">Effective Size</div>
                    <div class="signal-value">-- SOL</div>
                </div>
            </div>
            
            <div class="leverage-meter">
                <div class="leverage-marker" style="left: 0%;"></div>
                <div class="leverage-marker" style="left: 25%;"></div>
                <div class="leverage-marker" style="left: 50%;"></div>
                <div class="leverage-marker" style="left: 75%;"></div>
                <div class="leverage-marker" style="left: 100%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666;">
                <span>1x</span>
                <span>5x</span>
                <span>10x</span>
                <span>15x</span>
                <span>20x</span>
            </div>
        </div>
        
        <div class="card futures">
            <h2>‚öôÔ∏è Leverage Settings</h2>
            
            <div class="form-group">
                <label>Leverage Multiplier (1-20x):</label>
                <input type="number" id="leverageMultiplier" value="5" min="1" max="20" step="1">
                <small>Higher leverage = higher risk/reward. 20x maximum for safety.</small>
            </div>
            
            <div class="form-group">
                <label>Base Position Size (SOL):</label>
                <input type="number" id="basePositionSize" value="0.1" min="0.01" max="10" step="0.01">
                <small>Base SOL amount before leverage (0.01-10 SOL)</small>
            </div>
            
            <button onclick="updateSettings()" class="update-button" style="width: 100%;">Update Leverage Settings</button>
        </div>
        
        <div class="card futures">
            <h2>üéÆ Bot Control</h2>
            
            <div class="control-section">
                <div class="section-title">MAIN CONTROLS</div>
                <div class="button-group">
                    <button onclick="startBot()" id="startButton" class="start-button">üöÄ START FUTURES BOT</button>
                    <button onclick="stopBot()" id="stopButton" class="stop-button" disabled>üõë STOP BOT</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">POSITION CONTROL</div>
                <div class="button-group">
                    <button onclick="closePosition()" class="close-button">üìã CLOSE POSITION</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">EMERGENCY CONTROL</div>
                <div class="button-group emergency-group">
                    <button onclick="emergencyStop()" class="emergency-button">üö® EMERGENCY STOP</button>
                </div>
            </div>
            
            <div id="result" style="margin-top: 15px;"></div>
        </div>
        
        <div class="card futures">
            <h2>üìã Live Trade History</h2>
            <div class="trade-history" id="tradeHistory">
                <p style="text-align: center; color: #666; padding: 20px;">No futures trades yet</p>
            </div>
        </div>
        
        <div class="card">
            <h2>üîÑ System Controls</h2>
            <div class="button-group">
                <button onclick="refreshData()" class="refresh-button" style="background: linear-gradient(135deg, #00cec9, #81ecec); color: white;">üîÑ Refresh Data</button>
                <button onclick="getBalance()" class="balance-button" style="background: linear-gradient(135deg, #fd79a8, #fab1a0); color: white;">üí∞ Update Balance</button>
            </div>
        </div>
    </div>

    <script>
        async function apiCall(endpoint, method = 'GET') {
            try {
                const response = await fetch(endpoint, { method: method });
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return { status: 'error', message: 'Network error' };
            }
        }

        function formatPnl(value) {
            const numValue = parseFloat(value);
            if (numValue > 0) return `<span class="extreme-positive">+$${numValue.toFixed(2)}</span>`;
            if (numValue < 0) return `<span class="extreme-negative">-$${Math.abs(numValue).toFixed(2)}</span>`;
            return `$${numValue.toFixed(2)}`;
        }

        function formatPnlPercent(value) {
            const numValue = parseFloat(value);
            if (numValue > 0) return `<span class="extreme-positive">+${(numValue * 100).toFixed(2)}%</span>`;
            if (numValue < 0) return `<span class="extreme-negative">${(numValue * 100).toFixed(2)}%</span>`;
            return `0.00%`;
        }

        function updateSignalDisplay(action, value, elementId) {
            const element = document.getElementById(elementId);
            element.className = 'signal-item';
            
            if (action === 'LONG') {
                element.classList.add('long');
            } else if (action === 'SHORT') {
                element.classList.add('short');
            } else {
                element.classList.add('hold');
            }
            
            element.querySelector('.signal-value').textContent = value;
        }

        function updatePnlDisplay(unrealizedPnl, realizedPnl) {
            const pnlDisplay = document.getElementById('pnlDisplay');
            const unrealizedValue = parseFloat(unrealizedPnl) || 0;
            const realizedValue = parseFloat(realizedPnl) || 0;
            const totalPnl = unrealizedValue + realizedValue;
            
            pnlDisplay.className = 'pnl-display ' + 
                (totalPnl > 0 ? 'pnl-positive' : totalPnl < 0 ? 'pnl-negative' : 'pnl-neutral');
            
            pnlDisplay.innerHTML = `Total P&L: ${formatPnl(totalPnl)} (${formatPnlPercent(unrealizedPnl)})`;
        }

        async function startBot() {
            if (!confirm('üö® WARNING: FUTURES TRADING WITH LEVERAGE IS EXTREMELY HIGH RISK!\\n\\nYou could lose your entire account quickly.\\n\\nAre you absolutely sure you want to continue?')) {
                return;
            }
            
            const result = document.getElementById('result');
            result.innerHTML = '<div style="color: #00b894; font-weight: bold;">üöÄ Starting Futures Trading Bot...</div>';
            
            const data = await apiCall('/api/start_bot', 'POST');
            
            if (data.status === 'success') {
                result.innerHTML = '<div style="color: #00b894; font-weight: bold; animation: blink 1s infinite;">‚úÖ ' + data.message + '</div>';
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                setTimeout(refreshData, 1000);
            } else {
                result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
            }
        }

        async function stopBot() {
            const result = document.getElementById('result');
            result.innerHTML = '<div style="color: #fdcb6e; font-weight: bold;">‚èπÔ∏è Stopping Futures Bot...</div>';
            
            const data = await apiCall('/api/stop_bot', 'POST');
            
            if (data.status === 'success') {
                result.innerHTML = '<div style="color: #fdcb6e; font-weight: bold;">üõë ' + data.message + '</div>';
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                setTimeout(refreshData, 1000);
            } else {
                result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
            }
        }

        async function emergencyStop() {
            if (!confirm('üö® EMERGENCY STOP: This will immediately close all positions and stop the bot.\\n\\nAre you sure?')) {
                return;
            }
            
            const result = document.getElementById('result');
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold; animation: blink 0.5s infinite;">üö® EMERGENCY STOP ACTIVATED...</div>';
            
            // Close position first
            await apiCall('/api/close_position', 'POST');
            
            // Then stop the bot
            await apiCall('/api/stop_bot', 'POST');
            
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚úÖ EMERGENCY STOP COMPLETE</div>';
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            setTimeout(refreshData, 1000);
        }

        async function closePosition() {
            if (!confirm('Close current position?')) {
                return;
            }
            
            const result = document.getElementById('result');
            result.innerHTML = '<div style="color: #fd79a8; font-weight: bold;">Closing position...</div>';
            
            const data = await apiCall('/api/close_position', 'POST');
            
            if (data.status === 'success') {
                result.innerHTML = '<div style="color: #fd79a8; font-weight: bold;">‚úÖ ' + data.message + '</div>';
                setTimeout(refreshData, 1000);
            } else {
                result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
            }
        }

        async function updateSettings() {
            const leverage = document.getElementById('leverageMultiplier').value;
            const baseSize = document.getElementById('basePositionSize').value;
            
            const data = await apiCall(
                `/api/update_settings?leverage=${leverage}&base_size=${baseSize}`,
                'POST'
            );
            
            if (data.status === 'success') {
                document.getElementById('result').innerHTML = '<div style="color: #667eea; font-weight: bold;">‚úÖ ' + data.message + '</div>';
                setTimeout(refreshData, 500);
            } else {
                document.getElementById('result').innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
            }
        }

        async function refreshData() {
            const data = await apiCall('/api/status');
            
            if (data.status === 'success') {
                // Bot status
                document.getElementById('botStatus').textContent = data.is_running ? 'RUNNING üöÄ' : 'STOPPED';
                document.getElementById('botStatus').className = 'value ' + (data.is_running ? 'status-running' : 'status-stopped');
                
                // Position info
                document.getElementById('position').textContent = data.current_position || 'NONE';
                document.getElementById('position').className = 'value ' + 
                    (data.current_position === 'long' ? 'status-long' : 
                     data.current_position === 'short' ? 'status-short' : '');
                
                document.getElementById('positionSize').textContent = (data.position_size || 0).toFixed(3) + ' SOL';
                document.getElementById('entryPrice').textContent = '$' + (data.entry_price || 0).toFixed(2);
                
                // Market data
                document.getElementById('solPrice').textContent = '$' + (data.current_price || 0).toFixed(2);
                document.getElementById('accountBalance').textContent = '$' + (data.account_balance || 0).toFixed(2);
                document.getElementById('leverageDisplay').textContent = (data.leverage || 5) + 'x';
                
                // Performance data
                document.getElementById('unrealizedPnl').innerHTML = formatPnlPercent(data.unrealized_pnl || 0);
                document.getElementById('realizedPnl').innerHTML = formatPnl(data.realized_pnl || 0);
                document.getElementById('totalTrades').textContent = data.performance?.total_trades || 0;
                document.getElementById('winRate').textContent = data.performance?.win_rate ? (data.performance.win_rate * 100).toFixed(1) + '%' : '0%';
                
                // Update P&L display
                updatePnlDisplay(data.unrealized_pnl, data.realized_pnl);
                
                // Signals
                if (data.signals) {
                    updateSignalDisplay(data.signals.action, data.signals.rsi?.toFixed(1) || '--', 'rsiSignal');
                    updateSignalDisplay(data.signals.action, data.signals.macd === 1 ? 'BULL' : data.signals.macd === -1 ? 'BEAR' : '--', 'macdSignal');
                    updateSignalDisplay(data.signals.action, (data.signals.trend_strength || 0).toFixed(2), 'trendSignal');
                    updateSignalDisplay(data.signals.action, (data.signals.confidence * 100 || 0).toFixed(0) + '%', 'confidenceSignal');
                    updateSignalDisplay(data.signals.action, data.signals.action || 'HOLD', 'actionSignal');
                    
                    // Calculate effective size
                    const baseSize = parseFloat(document.getElementById('basePositionSize').value) || 0.1;
                    const leverage = parseFloat(document.getElementById('leverageMultiplier').value) || 5;
                    const confidence = data.signals.confidence || 0.5;
                    const effectiveSize = baseSize * leverage * confidence;
                    document.getElementById('leverageSignal').querySelector('.signal-value').textContent = effectiveSize.toFixed(3) + ' SOL';
                }
                
                // Settings form values
                document.getElementById('leverageMultiplier').value = data.leverage || 5;
                document.getElementById('basePositionSize').value = data.base_position_size || 0.1;
                
                // Trade history
                const tradeHistory = document.getElementById('tradeHistory');
                if (data.trade_history && data.trade_history.length > 0) {
                    tradeHistory.innerHTML = '';
                    data.trade_history.slice().reverse().forEach(trade => {
                        const tradeItem = document.createElement('div');
                        tradeItem.className = `trade-item ${trade.action.toLowerCase()}`;
                        tradeItem.innerHTML = `
                            <div class="trade-time">${new Date(trade.time).toLocaleString('en-US', { 
                                timeZone: 'America/New_York',
                                month: '2-digit',
                                day: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true 
                            })}</div>
                            <div class="trade-action">
                                ${trade.action} - ${trade.size} SOL @ $${trade.entry_price.toFixed(2)}
                                <br><small>Leverage: ${trade.leverage}x | Confidence: ${(trade.confidence * 100).toFixed(0)}%</small>
                            </div>
                        `;
                        tradeHistory.appendChild(tradeItem);
                    });
                } else {
                    tradeHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No futures trades yet</p>';
                }
                
                // Button states
                document.getElementById('startButton').disabled = data.is_running;
                document.getElementById('stopButton').disabled = !data.is_running;
                
            } else {
                document.getElementById('result').innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå Failed to get status</div>';
            }
        }

        async function getBalance() {
            const result = document.getElementById('result');
            result.innerHTML = '<div style="color: #00cec9; font-weight: bold;">üîÑ Updating balance...</div>';
            
            const data = await apiCall('/api/balance');
            
            if (data.status === 'success') {
                result.innerHTML = '<div style="color: #00cec9; font-weight: bold;">‚úÖ Balance updated</div>';
                setTimeout(refreshData, 500);
            } else {
                result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            // Auto-refresh every 10 seconds
            setInterval(refreshData, 10000);
        });
    </script>
</body>
</html>
    """

@app.route('/api/start_bot', methods=['POST'])
def start_bot():
    if trading_state.is_running:
        return jsonify({'status':'error','message':'Bot already running'})
    
    if not config.is_configured:
        return jsonify({'status':'error','message':'API not configured'})
    
    trading_state.is_running = True
    trading_thread = threading.Thread(target=futures_trading_loop, daemon=True)
    trading_thread.start()
    
    return jsonify({'status':'success','message':'üöÄ Futures trading bot activated!'})

@app.route('/api/stop_bot', methods=['POST'])
def stop_bot():
    if not trading_state.is_running:
        return jsonify({'status':'error','message':'Bot not running'})
    
    trading_state.is_running = False
    return jsonify({'status':'success','message':'Futures bot stopped'})

@app.route('/api/status')
def get_status():
    current_price = get_current_price()
    balance = get_account_balance()
    
    return jsonify({
        'status': 'success',
        'is_running': trading_state.is_running,
        'current_position': trading_state.current_position,
        'position_size': trading_state.position_size,
        'entry_price': trading_state.entry_price,
        'unrealized_pnl': trading_state.unrealized_pnl,
        'realized_pnl': trading_state.realized_pnl,
        'current_price': current_price,
        'account_balance': balance,
        'leverage': config.leverage_multiplier,
        'signals': trading_state.last_signals,
        'trade_history': trading_state.trade_history[-10:],
        'performance': {
            'total_trades': trading_state.total_trades,
            'winning_trades': trading_state.winning_trades,
            'win_rate': trading_state.winning_trades / trading_state.total_trades if trading_state.total_trades > 0 else 0
        }
    })

@app.route('/api/update_settings', methods=['POST'])
def update_settings():
    try:
        leverage = int(request.args.get('leverage', config.leverage_multiplier))
        base_size = float(request.args.get('base_size', config.base_position_size))
        
        if leverage < 1 or leverage > 20:
            return jsonify({'status':'error','message':'Leverage must be 1-20x'})
            
        if base_size < 0.01 or base_size > 10:
            return jsonify({'status':'error','message':'Base size must be 0.01-10 SOL'})
        
        config.leverage_multiplier = leverage
        config.base_position_size = base_size
        
        # Update leverage in real-time
        set_leverage()
        
        return jsonify({'status':'success','message':f'Updated: {leverage}x leverage, {base_size} SOL base'})
        
    except Exception as e:
        return jsonify({'status':'error','message':str(e)})

@app.route('/api/close_position', methods=['POST'])
def manual_close_position():
    try:
        if close_position():
            return jsonify({'status':'success','message':'Position closed'})
        else:
            return jsonify({'status':'error','message':'Failed to close position'})
    except Exception as e:
        return jsonify({'status':'error','message':str(e)})

@app.route('/api/balance')
def get_balance():
    try:
        balance = get_account_balance()
        return jsonify({'status':'success','balance': balance})
    except Exception as e:
        return jsonify({'status':'error','message':str(e)})

if __name__ == '__main__':
    print("\n" + "="*70)
    print("üöÄ FUTURES TRADING BOT")
    print("="*70)
    print(f"LEVERAGE: {config.leverage_multiplier}x")
    print(f"BASE SIZE: {config.base_position_size} SOL")
    print(f"SYMBOL: {config.symbol}")
    print(f"CHECK INTERVAL: {config.check_interval}s")
    print("\n‚ö†Ô∏è  WARNING: HIGH RISK - LEVERAGE TRADING")
    print("‚ö†Ô∏è  Potential for complete loss of capital")
    print("‚ö†Ô∏è  Only use risk capital you can afford to lose")
    print("="*70)
    
    # Use Railway's port or default to 5000
    port = int(os.environ.get('PORT', 5000))
    app.run(debug=False, host='0.0.0.0', port=port)
