<script>
    async function apiCall(endpoint, method = 'GET') {
        try {
            const baseUrl = window.location.origin; // Use current domain
            const response = await fetch(baseUrl + endpoint, { 
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            return { status: 'error', message: 'Network error: ' + error.message };
        }
    }

    function formatPnl(value) {
        if (value === null || value === undefined || value === '--') return '$0.00';
        const numValue = parseFloat(value);
        if (isNaN(numValue)) return '$0.00';
        if (numValue > 0) return `<span class="extreme-positive">+$${numValue.toFixed(2)}</span>`;
        if (numValue < 0) return `<span class="extreme-negative">-$${Math.abs(numValue).toFixed(2)}</span>`;
        return `$${numValue.toFixed(2)}`;
    }

    function formatPnlPercent(value) {
        if (value === null || value === undefined || value === '--') return '0.00%';
        const numValue = parseFloat(value);
        if (isNaN(numValue)) return '0.00%';
        if (numValue > 0) return `<span class="extreme-positive">+${numValue.toFixed(2)}%</span>`;
        if (numValue < 0) return `<span class="extreme-negative">${numValue.toFixed(2)}%</span>`;
        return `${numValue.toFixed(2)}%`;
    }

    function updateSignalDisplay(signal, value, elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.className = 'signal-item';
        
        if (signal === 'BUY') {
            element.classList.add('strong-buy');
        } else if (signal === 'SELL') {
            element.classList.add('strong-sell');
        } else {
            element.classList.add('hold');
        }
        
        const valueElement = element.querySelector('.signal-value');
        if (valueElement) {
            valueElement.textContent = value;
        }
    }

    async function startBot() {
        if (!confirm('üö® WARNING: This is an EXTREMELY HIGH RISK strategy.\n\nYou could lose your entire investment.\n\nAre you absolutely sure you want to continue?')) {
            return;
        }
        
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #00b894; font-weight: bold;">üöÄ Starting Aggressive Growth Bot...</div>';
        
        const data = await apiCall('/api/start_bot', 'POST');
        
        if (data.status === 'success') {
            result.innerHTML = '<div style="color: #00b894; font-weight: bold; animation: blink 1s infinite;">‚úÖ ' + data.message + '</div>';
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            setTimeout(refreshData, 1000);
        } else {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    async function stopBot() {
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #fdcb6e; font-weight: bold;">‚èπÔ∏è Stopping Aggressive Bot...</div>';
        
        const data = await apiCall('/api/stop_bot', 'POST');
        
        if (data.status === 'success') {
            result.innerHTML = '<div style="color: #fdcb6e; font-weight: bold;">üõë ' + data.message + '</div>';
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            setTimeout(refreshData, 1000);
        } else {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    async function emergencyStop() {
        if (!confirm('üö® EMERGENCY STOP: This will immediately close all positions and stop the bot.\n\nAre you sure?')) {
            return;
        }
        
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #ff7675; font-weight: bold; animation: blink 0.5s infinite;">üö® EMERGENCY STOP ACTIVATED...</div>';
        
        // First stop the bot
        await apiCall('/api/stop_bot', 'POST');
        
        // Then close any open position
        const status = await apiCall('/api/status');
        if (status.status === 'success' && status.last_position) {
            if (status.last_position === 'long') {
                await apiCall('/api/manual_sell?amount=' + status.sol_balance, 'POST');
            } else if (status.last_position === 'short') {
                await apiCall('/api/manual_buy?amount=' + status.sol_balance, 'POST');
            }
        }
        
        result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚úÖ EMERGENCY STOP COMPLETE - All positions closed</div>';
        document.getElementById('startButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
        setTimeout(refreshData, 1000);
    }

    async function updateSettings() {
        const baseAmount = document.getElementById('baseTradeAmount').value;
        const riskMultiplier = document.getElementById('riskMultiplier').value;
        const dailyLoss = document.getElementById('dailyLossLimit').value;
        const trailingStop = document.getElementById('trailingStop').value;
        
        const data = await apiCall(
            `/api/update_settings?base_trade_amount=${baseAmount}&risk_multiplier=${riskMultiplier}&daily_loss_limit=${dailyLoss}&trailing_stop=${trailingStop}`,
            'POST'
        );
        
        if (data.status === 'success') {
            document.getElementById('result').innerHTML = '<div style="color: #00b894; font-weight: bold;">‚úÖ Aggressive Settings Updated</div>';
            setTimeout(refreshData, 500);
        } else {
            document.getElementById('result').innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    async function manualBuy() {
        const amount = parseFloat(document.getElementById('baseTradeAmount').value);
        
        if (!confirm(`Execute manual BUY for ${amount} SOL?`)) {
            return;
        }
        
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #00b894; font-weight: bold;">üõí Executing Manual BUY...</div>';
        
        const data = await apiCall('/api/manual_buy?amount=' + amount, 'POST');
        
        if (data.status === 'success') {
            result.innerHTML = '<div style="color: #00b894; font-weight: bold;">‚úÖ ' + data.message + '</div>';
            setTimeout(() => refreshData(), 2000);
        } else {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    async function manualSell() {
        const amount = parseFloat(document.getElementById('baseTradeAmount').value);
        
        if (!confirm(`Execute manual SELL for ${amount} SOL?`)) {
            return;
        }
        
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">üí∞ Executing Manual SELL...</div>';
        
        const data = await apiCall('/api/manual_sell?amount=' + amount, 'POST');
        
        if (data.status === 'success') {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚úÖ ' + data.message + '</div>';
            setTimeout(() => refreshData(), 2000);
        } else {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    async function refreshData() {
        try {
            const data = await apiCall('/api/status');
            
            if (data.status === 'success') {
                // Bot status
                document.getElementById('botStatus').textContent = data.is_running ? 'RUNNING üöÄ' : 'STOPPED';
                document.getElementById('botStatus').className = 'value ' + (data.is_running ? 'status-running' : 'status-stopped');
                
                document.getElementById('position').textContent = data.last_position || 'NONE';
                
                // Market data - with better fallbacks
                const solPrice = data.signals?.price || data.current_sol_price || 0;
                document.getElementById('solPrice').textContent = '$' + solPrice.toFixed(2);
                document.getElementById('solBalance').textContent = (data.sol_balance || 0).toFixed(4) + ' SOL';
                document.getElementById('usdtBalance').textContent = '$' + (data.usdt_balance || 0).toFixed(2);
                document.getElementById('tradeAmountDisplay').textContent = (data.base_trade_amount || 0.2) + ' SOL';
                
                // Performance data
                if (data.performance_data) {
                    document.getElementById('dailyPnl').innerHTML = formatPnl(data.performance_data.daily_pnl || 0);
                    document.getElementById('totalPnl').innerHTML = formatPnl(data.performance_data.total_pnl || 0);
                    document.getElementById('totalPnlPercent').innerHTML = formatPnlPercent(data.performance_data.total_pnl_percentage || 0);
                    document.getElementById('totalTrades').textContent = data.performance_data.total_trades || 0;
                    document.getElementById('winRate').textContent = data.performance_data.win_rate ? (data.performance_data.win_rate * 100).toFixed(1) + '%' : '--%';
                    document.getElementById('currentStreak').textContent = data.performance_data.current_streak || 0;
                } else {
                    // Fallback if performance_data is missing
                    document.getElementById('dailyPnl').innerHTML = formatPnl(0);
                    document.getElementById('totalPnl').innerHTML = formatPnl(0);
                    document.getElementById('totalPnlPercent').innerHTML = formatPnlPercent(0);
                    document.getElementById('totalTrades').textContent = '0';
                    document.getElementById('winRate').textContent = '--%';
                    document.getElementById('currentStreak').textContent = '0';
                }
                
                // Signals
                if (data.signals) {
                    updateSignalDisplay(data.signals.action, data.signals.rsi?.toFixed(1) || '--', 'rsiSignal');
                    updateSignalDisplay(data.signals.action, data.signals.macd || '--', 'macdSignal');
                    updateSignalDisplay(data.signals.action, (data.signals.volume_strength || 0).toFixed(1) + 'x', 'volumeSignal');
                    updateSignalDisplay(data.signals.action, (data.signals.trend_strength || 0).toFixed(2), 'trendSignal');
                    updateSignalDisplay(data.signals.action, data.signals.action || 'HOLD', 'actionSignal');
                    updateSignalDisplay(data.signals.action, (data.signals.trade_multiplier || 1.0).toFixed(1) + 'x', 'multiplierSignal');
                } else {
                    // Fallback if signals are missing
                    updateSignalDisplay('HOLD', '--', 'rsiSignal');
                    updateSignalDisplay('HOLD', '--', 'macdSignal');
                    updateSignalDisplay('HOLD', '1.0x', 'volumeSignal');
                    updateSignalDisplay('HOLD', '0.00', 'trendSignal');
                    updateSignalDisplay('HOLD', 'HOLD', 'actionSignal');
                    updateSignalDisplay('HOLD', '1.0x', 'multiplierSignal');
                }
                
                // Settings form values
                document.getElementById('baseTradeAmount').value = data.base_trade_amount || 0.2;
                document.getElementById('riskMultiplier').value = data.risk_multiplier || 1.5;
                document.getElementById('dailyLossLimit').value = data.daily_loss_limit || 15;
                document.getElementById('trailingStop').value = data.trailing_stop || 8;
                
                // Trade history
                const tradeHistory = document.getElementById('tradeHistory');
                if (data.trade_history && data.trade_history.length > 0) {
                    tradeHistory.innerHTML = '';
                    data.trade_history.slice().reverse().forEach(trade => {
                        const tradeItem = document.createElement('div');
                        tradeItem.className = `trade-item ${trade.action.includes('BUY') ? 'buy' : 'sell'}`;
                        tradeItem.innerHTML = `
                            <div class="trade-time">${new Date(trade.time).toLocaleString('en-US', { 
                                timeZone: 'America/New_York',
                                month: '2-digit',
                                day: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true 
                            })}</div>
                            <div class="trade-action">
                                ${trade.action} - ${trade.sol_amount} SOL @ $${trade.price.toFixed(2)}
                                ${trade.signals?.trade_multiplier ? `<br><small>Multiplier: ${trade.signals.trade_multiplier.toFixed(1)}x</small>` : ''}
                            </div>
                        `;
                        tradeHistory.appendChild(tradeItem);
                    });
                } else {
                    tradeHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No aggressive trades yet</p>';
                }
                
                // Button states
                document.getElementById('startButton').disabled = data.is_running;
                document.getElementById('stopButton').disabled = !data.is_running;
                
            } else {
                document.getElementById('result').innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå Failed to get status: ' + (data.message || 'Unknown error') + '</div>';
            }
        } catch (error) {
            console.error('Refresh error:', error);
            document.getElementById('result').innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå Connection error: ' + error.message + '</div>';
        }
    }

    async function getBalance() {
        const result = document.getElementById('result');
        result.innerHTML = '<div style="color: #00cec9; font-weight: bold;">üîÑ Updating balances...</div>';
        
        const data = await apiCall('/api/balance');
        
        if (data.status === 'success') {
            result.innerHTML = '<div style="color: #00cec9; font-weight: bold;">‚úÖ Balances updated</div>';
            setTimeout(refreshData, 500);
        } else {
            result.innerHTML = '<div style="color: #ff7675; font-weight: bold;">‚ùå ' + data.message + '</div>';
        }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Aggressive SOL Bot Interface Loaded');
        refreshData();
        // Auto-refresh every 10 seconds for aggressive trading
        setInterval(refreshData, 10000);
    });
</script>
